# Data Flow Diagram

## ASCII Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DATA FLOW - TRADING PIPELINE                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: INGESTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Finnhub WebSocket
         â”‚
         â”‚ {"type":"trade", "data":[{...}]}
         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Validator  â”‚ âœ“ Check: s, p, t, v present
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ âœ“ Validate: price > 0, volume > 0
          â”‚        âœ“ Enrich: add processed_at
          â–¼
   {"symbol": "AAPL", "price": 150.25, ...}


Step 2: QUEUEING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Kafka Topic  â”‚
   â”‚ Partition 0  â”‚ â† AAPL trades
   â”‚ Partition 1  â”‚ â† GOOGL trades
   â”‚ Partition 2  â”‚ â† MSFT trades
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ Consumer Group: spark-streaming
          â”‚ Offset tracking âœ“


Step 3: PROCESSING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Spark Streaming   â”‚
   â”‚  Micro-batch: 5s   â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚       â”‚
          â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                         â”‚
          â–¼                         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Raw Trades   â”‚        â”‚  Aggregation    â”‚
   â”‚ Processing   â”‚        â”‚  (1-min Window) â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                         â”‚
          â”‚ Add Partitions          â”‚ Calculate OHLCV
          â”‚ â€¢ trade_year            â”‚ â€¢ Open: first
          â”‚ â€¢ trade_month           â”‚ â€¢ High: max
          â”‚ â€¢ trade_day             â”‚ â€¢ Low: min
          â”‚ â€¢ trade_hour            â”‚ â€¢ Close: last
          â”‚                         â”‚ â€¢ Volume: sum
          â–¼                         â–¼


Step 4: STORAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    trades_v2        â”‚      â”‚  trade_aggregates    â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ PK: (symbol,        â”‚      â”‚ PK: (symbol,         â”‚
   â”‚      year, month,   â”‚      â”‚      year, month)    â”‚
   â”‚      day)           â”‚      â”‚ CK: window_start     â”‚
   â”‚ CK: timestamp DESC  â”‚      â”‚                      â”‚
   â”‚ TTL: 30 days        â”‚      â”‚ TTL: 90 days         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Step 5: QUERY & VISUALIZATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Grafana Dashboards          â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚  â”‚  Real-time Price Chart â”‚  â”‚
   â”‚  â”‚  ðŸ“ˆ                    â”‚  â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚  â”‚  Volume Bar Chart      â”‚  â”‚
   â”‚  â”‚  ðŸ“Š                    â”‚  â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


MONITORING FLOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

   Producer â”€â”€â”
              â”‚
   Kafka   â”€â”€â”€â”¼â”€â”€â–º Prometheus â”€â”€â–º Alertmanager â”€â”€â–º Slack
              â”‚      â€¢ Scrape       â€¢ Evaluate      â€¢ Notify
   Spark   â”€â”€â”€â”¤      â€¢ Store        â€¢ Route         â€¢ Alert
              â”‚      â€¢ Query        â€¢ Dedupe
   Cassandra â”˜


LATENCY BREAKDOWN (P95)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Producer â†’ Kafka:     10ms  â–ˆâ–ˆâ–ˆâ–ˆ
Kafka â†’ Spark:       100ms  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
Spark Processing:   2000ms  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
Spark â†’ Cassandra:   500ms  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total E2E:         ~2610ms  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
```

## To Create Flowchart:

### Mermaid Flowchart
```mermaid
sequenceDiagram
    participant F as Finnhub API
    participant P as Producer
    participant K as Kafka
    participant S as Spark
    participant C as Cassandra
    participant G as Grafana

    F->>P: WebSocket Trade
    P->>P: Validate & Enrich
    P->>K: Produce Message
    K->>S: Consume (5s batch)
    
    par Raw Trades
        S->>C: Write trades_v2
    and Aggregates
        S->>S: Calculate OHLCV
        S->>C: Write trade_aggregates
    end
    
    G->>C: Query Trades
    C-->>G: Return Results
    G->>G: Render Dashboard
    
    Note over P,S: Metrics exported to Prometheus
```

Save as `data-flow.mmd` and render with GitHub or mermaid CLI.